<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Client Conversation – Starter Template</title>
  <style>
    :root{
      --blue:#3b82f6; /* accent */
      --blue-200:#dbeafe;
      --bg:#eef2f7; /* desktop wallpaper */
      --ink:#0f172a; /* text */
      --panel:#ffffff; /* windows */
      --muted:#64748b;
      --ring: rgba(59,130,246,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#f6f7fb;color:var(--ink);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}

    /* Desktop monitor container */
    .desktop{
      max-width:1100px; height:720px; margin:24px auto; border:3px solid #11182720; border-radius:18px; background:var(--bg);
      box-shadow:0 20px 40px rgba(2,8,23,.08);
      position:relative; overflow:hidden;
      display:grid; grid-template-columns:80px 1fr; grid-template-rows:1fr auto; grid-template-areas:"sidebar main" "sidebar mentor";
    }

    /* Logo as part of wallpaper */
    .logo{position:absolute; top:16px; left:16px; width:96px; height:44px; border-radius:8px; background:var(--blue); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; letter-spacing:.5px}

    /* Sidebar (icon bar) */
    .sidebar{grid-area:sidebar; padding:12px 8px; border-right:1px solid #0f172a10; display:flex; flex-direction:column; gap:10px; align-items:center}
    .app-btn{width:52px; height:52px; border-radius:12px; border:1px solid #0f172a14; background:#fff; display:grid; place-items:center; cursor:pointer; box-shadow:0 2px 6px rgba(2,8,23,.05);
      transition:transform .06s ease, box-shadow .2s ease, border-color .2s ease}
    .app-btn:focus-visible{outline:3px solid var(--ring)}
    .app-btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(2,8,23,.08)}
    .app-btn.active{border-color:var(--blue)}
    .app-ico{font-weight:700; color:var(--blue)}
    .spacer{flex:1}

    /* Main workspace window */
    .main{grid-area:main; display:flex; align-items:stretch; justify-content:center; padding:24px; overflow:hidden}
    .window{width:100%; max-width:940px; background:var(--panel); border:1px solid #0f172a12; border-radius:16px; box-shadow:0 8px 24px rgba(2,8,23,.06); position:relative; overflow:hidden}
    .titlebar{height:44px; display:flex; align-items:center; gap:12px; padding:0 14px; border-bottom:1px solid #0f172a10; background:#fff}
    .dots{display:flex; gap:8px; margin-right:6px}
    .dot{width:10px; height:10px; border-radius:999px}
    .dot.red{background:#f87171} .dot.yellow{background:#fbbf24} .dot.green{background:#34d399}
    .title{font-weight:600; color:#0f172a}
    .content{padding:18px; height:calc(100% - 44px); overflow:auto}

    /* Mentor floating panel */
    .mentor{grid-area:mentor; display:flex; align-items:center; gap:12px; padding:10px 14px; border-top:1px solid #0f172a10; background:#fff}
    .mentor.hidden{display:none}
    .mentor .avatar{width:56px; height:56px; border-radius:12px; background:var(--blue-200); display:grid; place-items:center; font-weight:700; color:var(--blue)}
    .mentor .text{flex:1; font-size:15px}

    /* Email UI */
    .email-form{display:grid; gap:10px}
    .field{display:grid; gap:6px}
    label{font-size:13px; color:var(--muted)}
    input[type="text"], .textarea{width:100%; padding:10px 12px; border:1px solid #0f172a22; border-radius:10px; background:#fff}
    .textarea{min-height:140px}
    .choice-row{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
    .choice{padding:10px 12px; border:1px dashed var(--blue); color:#0b3b88; background:var(--blue-200); border-radius:10px; cursor:pointer}

    /* Text UI */
    .thread{border:1px solid #0f172a12; border-radius:12px; padding:12px; height:240px; overflow:auto; background:#fff}
    .sms{max-width:70%; padding:8px 10px; border-radius:12px; margin:6px 0}
    .sms.me{margin-left:auto; background:var(--blue); color:#fff}
    .sms.them{background:#e5e7eb}

    /* Video UI */
    .video-wrap{display:grid; gap:12px}
    video{width:100%; border-radius:12px; background:#000}
    .video-actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{padding:10px 12px; border-radius:10px; border:1px solid #0f172a14; background:#fff; cursor:pointer}
    .btn.primary{background:var(--blue); color:#fff; border-color:transparent}

    /* Utility */
    .visually-hidden{position:absolute!important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px)}

    /* Responsive tweaks */
    @media (max-width: 900px){
      .desktop{height:auto; grid-template-rows:auto auto; }
      .main{padding:12px}
      .window{max-width:100%}
      .mentor{position:static}
    }
  </style>
</head>
<body>

  <div class="desktop" role="application" aria-label="The Client Conversation Simulation">
    <div class="logo" aria-hidden="true">ACME</div>

    <!-- Sidebar Icon Bar -->
    <nav class="sidebar" aria-label="Apps">
      <button class="app-btn active" data-app="email" aria-label="Open Email"><span class="app-ico">E</span></button>
      <button class="app-btn" data-app="text" aria-label="Open Text"><span class="app-ico">T</span></button>
      <button class="app-btn" data-app="video" aria-label="Open Video Call"><span class="app-ico">V</span></button>
      <button class="app-btn" data-app="calendar" aria-label="Open Calendar"><span class="app-ico">C</span></button>
      <button class="app-btn" data-app="tasks" aria-label="Open Tasks"><span class="app-ico">Tk</span></button>
      <button class="app-btn" data-app="notes" aria-label="Open Notes"><span class="app-ico">N</span></button>
      <div class="spacer"></div>
      <button class="app-btn" id="replay" aria-label="Replay Simulation"><span class="app-ico">↺</span></button>
    </nav>

    <!-- Main Window -->
    <section class="main">
      <div class="window" id="window">
        <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title" id="title">Email Client</div></div>
        <div class="content" id="content">
          <!-- Dynamic content injected by JS -->
        </div>
      </div>
    </section>

    <!-- Mentor Panel -->
    <aside class="mentor" id="mentor">
      <div class="avatar" aria-hidden="true">A</div>
      <div class="text" id="mentorText">How you communicate — both the channel and the tone — shapes how the client sees you. Choose wisely.</div>
    </aside>
  </div>

  <script>
  // Wrap everything to avoid duplicate globals on re-run
  (function(){
    'use strict';

    // Guard against double-initialization in hot-reload environments
    if (window.__CLIENT_CONVO_MOUNTED__) {
      console.info('[ClientConversation] Already initialized; skipping re-mount.');
      return;
    }
    window.__CLIENT_CONVO_MOUNTED__ = true;

    /* ==========================
       STATE & MAPPINGS
    ========================== */
    const state = {
      mediumChoice: null,   // 'email' | 'text' | 'video'
      toneScore: 0,         // positive paths add +1, rigid/defensive add -1
      stage: 'opening'      // 'opening' | 'dp1' | 'transition' | 'final' | 'wrap'
    };

    // Video file placeholders – replace with your actual assets
    const media = {
      salesOpen: 'video_salesmanager_open.mp4',
      salesTransition: 'video_salesmanager_transition.mp4',
      salesWrap: 'video_salesmanager_wrapup.mp4',
      clientPosEmail: 'client_reply_positive_email.mp4',
      clientNegEmail: 'client_reply_negative_email.mp4',
      clientPosText: 'client_reply_positive_text.mp4',
      clientNeuText: 'client_reply_neutral_text.mp4',
      clientVidPosIntro: 'client_video_positive_intro.mp4',
      clientVidNegIntro: 'client_video_concerned_intro.mp4',
      clientFinalPos: 'client_video_final_positive.mp4',
      clientFinalNeg: 'client_video_final_negative.mp4'
    };

    // Mentor lines
    const mentor = {
      open: "How you communicate — both the channel and the tone — shapes how the client sees you. Choose wisely.",
      emailGood: "Strong move. You acknowledged the concern and kept the door open for conversation. This sets a constructive tone.",
      emailCurt: "Direct, but it risks sounding dismissive. With sensitive clients, warmth and empathy go a long way.",
      textReassure: "Nice job. Even in a short format, you conveyed openness and flexibility.",
      textCallNow: "This is efficient, but be careful not to rush. Some clients need a bit of transition before diving into a call.",
      vidEmpath: "Excellent. You’re framing it as a partnership.",
      vidDefend: "Clear, but risks sounding rigid.",
      finalPos: "This is great news! You kept a warm, professional tone and adapted to the client’s needs. Great job.",
      finalNeg: "Not the best outcome. Your initial tone made it harder to build rapport. Think about how to connect before moving into problem-solving."
    };

    // Cache DOM refs (scoped inside IIFE to avoid duplicate consts)
    const titleEl = document.getElementById('title');
    const contentEl = document.getElementById('content');
    const mentorEl = document.getElementById('mentor');
    const mentorTextEl = document.getElementById('mentorText');

    /* ==========================
       HELPERS
    ========================== */
    function setTitle(t){ titleEl.textContent = t; }
    function setMentor(text){ mentorTextEl.textContent = text; }
    function clearContent(){ contentEl.innerHTML = ''; }

    function playVideo(src, onend){
      clearContent();
      const wrap = document.createElement('div');
      wrap.className = 'video-wrap';
      const vid = document.createElement('video');
      vid.src = src; vid.controls = true; vid.autoplay = true;
      vid.addEventListener('ended', ()=> onend && onend());
      wrap.appendChild(vid);
      contentEl.appendChild(wrap);
      return vid;
    }

    function row(elType, cls, html){
      const el = document.createElement(elType); el.className = cls; if(html) el.innerHTML = html; return el;
    }

    // Pure function to decide outcome – used by UI and tests
    function decideOutcome(toneScore, threshold=1){
      return toneScore >= threshold ? 'positive' : 'negative';
    }

    /* ==========================
       SCREENS
    ========================== */
    function screenOpening(){
      state.stage = 'opening';
      setTitle('Sales Manager – Intro');
      playVideo(media.salesOpen, ()=>{
        // After intro, reveal mentor and go to DP1 default view (email)
        mentorEl.classList.remove('hidden');
        setMentor(mentor.open);
        screenEmail();
      });
    }

    // EMAIL
    function screenEmail(){
      state.mediumChoice = 'email'; state.stage = 'dp1';
      setTitle('Email Client'); clearContent();
      const form = row('div','email-form');
      form.append(
        row('div','field',`<label>To</label><input type="text" value="Jamie @ ACME" aria-label="To">`),
        row('div','field',`<label>Subject</label><input type="text" value="Follow-up on pricing and delivery" aria-label="Subject">`),
        row('div','field',`<label>Message</label><div class="textarea" role="textbox" aria-label="Message body" contenteditable>
          Hi Jamie, I understand your concerns about pricing and delivery. Let’s discuss how we can address these points so you’re confident moving forward.
        </div>`)
      );
      const choices = row('div','choice-row');
      const cGood = row('button','choice','Send: Empathetic & Professional');
      cGood.addEventListener('click', ()=> {
        setMentor(mentor.emailGood); state.toneScore += 1; // positive tone
        // client reply (text overlay simulated)
        clearContent();
        const p = row('p','',`<strong>Client (reply):</strong> Thanks for the thoughtful reply. I do want to talk this through in more detail. Can we set up a quick video call?`);
        contentEl.appendChild(p);
        setTimeout(screenTransition, 1200);
      });
      const cCurt = row('button','choice','Send: Curt & Transactional');
      cCurt.addEventListener('click', ()=> {
        setMentor(mentor.emailCurt); state.toneScore -= 1; // negative tone
        clearContent();
        const p = row('p','',`<strong>Client (reply):</strong> I think we do need to talk — I have major concerns. Can we set up a call?`);
        contentEl.appendChild(p);
        setTimeout(screenTransition, 1200);
      });
      choices.append(cGood, cCurt);
      contentEl.append(form, choices);
      setActiveBtn('email');
    }

    // TEXT
    function screenText(){
      state.mediumChoice = 'text'; state.stage = 'dp1'; setTitle('Messaging'); clearContent();
      const thread = row('div','thread');
      thread.append(
        bubble('them','Hey, can we revisit pricing and the delivery date?'),
        bubble('me','Absolutely. Let’s talk it through.')
      );
      const choices = row('div','choice-row');
      const cReassure = row('button','choice','Send: Reassuring Text');
      cReassure.addEventListener('click', ()=>{
        thread.append(bubble('me','Hi Jamie — I saw your note. Let’s talk about your concerns and find the best solution.'));
        setMentor(mentor.textReassure); state.toneScore += 1;
        setTimeout(()=>{
          thread.append(bubble('them','Thanks — let’s set up a video call later today.'));
          setTimeout(screenTransition, 1200);
        }, 700);
      });
      const cCallNow = row('button','choice','Send: Ask to Call Now');
      cCallNow.addEventListener('click', ()=>{
        thread.append(bubble('me','Hi Jamie — I saw your concerns. Can you jump on a video call now?'));
        setMentor(mentor.textCallNow); /* neutral */
        setTimeout(()=>{
          thread.append(bubble('them','Yes, I’m available — let’s talk.'));
          setTimeout(screenTransition, 1200);
        }, 700);
      });
      choices.append(cReassure, cCallNow);
      contentEl.append(thread, choices);
      setActiveBtn('text');
    }

    function bubble(who,text){ const b=row('div','sms '+(who==='me'?'me':'them')); b.textContent=text; return b; }

    // VIDEO CALL
    function screenVideo(){
      state.mediumChoice = 'video'; state.stage = 'dp1'; setTitle('Video Call');
      const wrap = row('div','video-wrap');
      const vid = document.createElement('video'); vid.controls = true; vid.autoplay = true; vid.src = media.clientVidPosIntro; // placeholder intro
      wrap.appendChild(vid);
      const actions = row('div','video-actions');
      const aEmp = row('button','btn primary','Say: Review priorities & adjust');
      aEmp.addEventListener('click', ()=>{ setMentor(mentor.vidEmpath); state.toneScore += 1; screenTransition(); });
      const aDef = row('button','btn','Say: Terms are set – review them');
      aDef.addEventListener('click', ()=>{ setMentor(mentor.vidDefend); state.toneScore -= 1; screenTransition(); });
      actions.append(aEmp,aDef);
      wrap.appendChild(actions); clearContent(); contentEl.appendChild(wrap); setActiveBtn('video');
    }

    // TRANSITION SCENE
    function screenTransition(){
